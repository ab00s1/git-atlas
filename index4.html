<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FileAtlas MVP</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: #f6f7fb;
      color: #111827;
    }
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 { margin: 0 0 6px 0; }
    .muted { color: #6b7280; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

    input {
      flex: 1 1 520px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      outline: none;
    }
    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #111827;
      background: #111827;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    button.secondary {
      background: #fff;
      color: #111827;
      border: 1px solid #e5e7eb;
    }
    button:disabled { opacity: .5; cursor: not-allowed; }

    .card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 14px;
      margin-bottom: 12px;
    }
    #viz {
      width: 100%;
      height: 720px;
      border-radius: 16px;
      background: #fff;
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }
    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #fafafa;
      font-size: 12px;
    }
    .err {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 12px;
      border-radius: 12px;
    }
    .tooltip {
      position: fixed;
      pointer-events: none;
      background: rgba(17,24,39,.92);
      color: #fff;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      white-space: nowrap;
      display: none;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>FileAtlas</h1>
    <div class="muted">Visual, drill-down maps of GitHub repositories</div>

    <div class="card">
      <div class="row">
        <input id="repoUrl" value="https://github.com/git/git" />
        <button id="go">Visualize</button>
        <span id="status" class="pill">Idle</span>
      </div>
      <div id="message" style="margin-top:10px;"></div>
    </div>

    <div id="nav" class="card" style="display:none;"></div>
    <div id="viz"></div>
  </div>

  <div id="tooltip" class="tooltip"></div>

  <!-- D3 -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

  <script>
    const $ = s => document.querySelector(s);
    const viz = $("#viz");
    const nav = $("#nav");
    const tooltip = $("#tooltip");
    const statusEl = $("#status");
    const msgEl = $("#message");
    const btn = $("#go");

    let FULL_ROOT = null;
    let CURRENT = null;

    function setStatus(t) { statusEl.textContent = t; }
    function setMessage(html, err=false) {
      msgEl.innerHTML = html ? (err ? `<div class="err">${html}</div>` : html) : "";
    }

    function parseGitHubUrl(url) {
      try {
        const u = new URL(url);
        if (u.hostname !== "github.com") return null;
        const parts = u.pathname.split("/").filter(Boolean);
        return parts.length >= 2 ? { owner: parts[0], repo: parts[1] } : null;
      } catch { return null; }
    }

    function extColor(ext) {
      const map = {
        js:"#a3e635", ts:"#3b82f6", md:"#f59e0b",
        json:"#a855f7", c:"#60a5fa", h:"#38bdf8", py:"#3572A5"
      };
      return map[ext] || "#9ca3af";
    }

    function treeListToHierarchy(list) {
      const root = { name:"repo", type:"dir", children:[] };

      const ensureDir = (p, n) => {
        let d = p.children.find(c => c.type==="dir" && c.name===n);
        if (!d) p.children.push(d = { name:n, type:"dir", children:[] });
        return d;
      };

      for (const it of list) {
        const parts = it.path.split("/");
        let node = root;
        for (let i=0;i<parts.length;i++) {
          const last = i === parts.length - 1;
          if (!last) node = ensureDir(node, parts[i]);
          else if (it.type === "blob") {
            node.children.push({
              name: parts[i],
              type: "file",
              size: it.size || 1,
              ext: parts[i].split(".").pop().toLowerCase(),
              path: it.path
            });
          }
        }
      }
      return root;
    }

    async function gh(url) {
      const r = await fetch(url, { headers:{Accept:"application/vnd.github+json"} });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    function pathOf(n){
      const p=[];
      while(n){ if(n.parent) p.push(n.data.name); n=n.parent; }
      return ["repo"].concat(p.reverse());
    }

    function findChild(node,name){
      return node.children.find(c=>c.data.name===name) || node;
    }

    function render() {
      viz.innerHTML = "";
      nav.style.display = "block";

      const width = viz.clientWidth;
      const height = viz.clientHeight;

      const root = d3.hierarchy(CURRENT.data)
        .sum(d => d.type === "file" ? d.size : 0)
        .sort((a,b) => (b.value||0)-(a.value||0));

      d3.pack().size([width,height]).padding(4)(root);

      nav.innerHTML = `
        <div class="row">
          <span class="pill">${pathOf(CURRENT).join(" / ")}</span>
          <button class="secondary" ${CURRENT.parent?"":"disabled"} id="back">Back</button>
          <button class="secondary" ${CURRENT!==FULL_ROOT?"":"disabled"} id="root">Root</button>
        </div>
      `;

      $("#back")?.addEventListener("click",()=>{ CURRENT=CURRENT.parent; render(); });
      $("#root")?.addEventListener("click",()=>{ CURRENT=FULL_ROOT; render(); });

      const svg = d3.select(viz).append("svg")
        .attr("width","100%")
        .attr("height","100%");

      const nodes = svg.selectAll("g.node")
        .data(root.descendants())
        .join("g")
        .attr("class","node")
        .attr("transform",d=>`translate(${d.x},${d.y})`)
        .style("cursor",d=>d.data.type==="dir" && d.depth>0?"pointer":"default")
        .on("click",(e,d)=>{
          if (d.data.type==="dir" && d.depth>0) {
            CURRENT = findChild(CURRENT,d.data.name);
            render();
          }
        })
        .on("mousemove",(e,d)=>{
          tooltip.style.display="block";
          tooltip.textContent = d.data.type==="file"
            ? `${d.data.path} (${Math.round(d.value/1024)} KB)`
            : d.data.name + "/";
          tooltip.style.left=e.clientX+12+"px";
          tooltip.style.top=e.clientY+12+"px";
        })
        .on("mouseleave",()=>tooltip.style.display="none");

      // circles
      nodes.append("circle")
        .attr("r",d=>d.r)
        .attr("fill",d=>d.data.type==="dir"?"#f3f4f6":extColor(d.data.ext))
        .attr("stroke","#e5e7eb");

      // labels (scaled by circle radius)
      const labels = svg.append("g");

      labels.selectAll("text")
        .data(root.descendants().filter(d => d.depth === 1 && d.r > 18))
        .join("text")
        .attr("x", d => d.x)
        .attr("y", d => d.y)
        .attr("text-anchor","middle")
        .attr("dominant-baseline","middle")
        .style("pointer-events","none")
        .style("font-weight","700")
        .style("fill", d => d.data.type === "dir" ? "#111827" : "#111827")
        .style("paint-order","stroke")
        .style("stroke","#ffffff")
        .style("stroke-width","3px")
        .style("font-size", d => {
          // üîë font scales with circle size
          const size = d.r * 0.35;
          return Math.max(12, Math.min(26, size)) + "px";
        })
        .text(d => {
          const n = d.data.name;
          return n.length > 18 ? n.slice(0,18) + "‚Ä¶" : n;
        });
    }

    async function load() {
      const parsed = parseGitHubUrl($("#repoUrl").value);
      if (!parsed) return setMessage("Invalid GitHub URL",true);

      btn.disabled=true;
      setStatus("Loading‚Ä¶");
      setMessage("");

      try {
        const repo = await gh(`https://api.github.com/repos/${parsed.owner}/${parsed.repo}`);
        const branch = repo.default_branch;
        const info = await gh(`https://api.github.com/repos/${parsed.owner}/${parsed.repo}/branches/${branch}`);
        const sha = info.commit.commit.tree.sha;
        const tree = await gh(`https://api.github.com/repos/${parsed.owner}/${parsed.repo}/git/trees/${sha}?recursive=1`);

        if (tree.truncated)
          setMessage(`<div class="pill">‚ö†Ô∏è Large repo ‚Äî partial tree</div>`);

        const data = treeListToHierarchy(tree.tree);
        FULL_ROOT = d3.hierarchy(data);
        CURRENT = FULL_ROOT;
        render();
        setStatus("Loaded");
      } catch(e){
        setMessage(e.message,true);
        setStatus("Error");
      } finally {
        btn.disabled=false;
      }
    }

    $("#go").addEventListener("click", load);
    load();
  </script>
</body>
</html>

